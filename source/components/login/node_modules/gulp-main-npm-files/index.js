var fs = require('fs');
var path = require('path');

module.exports = function(options) {
  function getMainFile(modulePath) {
    var json = JSON.parse(fs.readFileSync(modulePath + '/package.json'));
    return modulePath + "/" + (json.main || "index.js");
  };

  options = options || {};

  if(!options.nodeModulesPath) {
    options.nodeModulesPath = './node_modules';
  } else if (!path.isAbsolute(options.nodeModulesPath) ){
    options.nodeModulesPath = path.join(path.dirname(__filename), options.nodeModulesPath)
  }

  if(!options.packageJsonPath) {
    options.packageJsonPath = './package.json';
  } else if (!path.isAbsolute(options.packageJsonPath) ){
    options.packageJsonPath = path.join(path.dirname(__filename), options.packageJsonPath)
  }

  console.log(_filename);
  console.log(path.dirname(__filename));

  var buffer, packages, keys;
  buffer = fs.readFileSync(options.packageJsonPath);
  packages = JSON.parse(buffer.toString());
  keys = [];

  for (var key in packages.dependencies) {
    keys.push(getMainFile(options.nodeModulesPath + "/" + key));
  }

  if (options.devDependencies) {
    for (var key in packages.devDependencies) {
      keys.push(getMainFile(options.nodeModulesPath + "/" + key));
    }
  }

  return keys;
};
